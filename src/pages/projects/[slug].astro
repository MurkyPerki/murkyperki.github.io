---
import Layout from "../../layouts/Layout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((p) => ({ params: { slug: p.slug }, props: { p } }));
}

const { p } = Astro.props as { p: CollectionEntry<"projects"> };
const { Content } = await p.render();

// Get all projects for prev/next navigation
const allProjects = await getCollection("projects");
const currentIndex = allProjects.findIndex((proj) => proj.slug === p.slug);
const prevProject = currentIndex > 0 ? allProjects[currentIndex - 1] : null;
const nextProject = currentIndex < allProjects.length - 1 ? allProjects[currentIndex + 1] : null;
---
<Layout title={`${p.data.title} ‚Äî Max Burkhardt`} description={p.data.pitch || `Project: ${p.data.title}`}>
  <article class="container" style="padding: var(--spacing-xl) var(--spacing-md);">
    <div class="content-narrow">
      <!-- Cover Image (optional) -->
      {p.data.cover && (
        <img 
          src={p.data.cover} 
          alt={`${p.data.title} cover`}
          style="width: 100%; height: 400px; object-fit: cover; border-radius: 12px; margin-bottom: var(--spacing-xl);"
          class="reveal"
        />
      )}
      
      <!-- Header -->
      <header class="reveal" style="margin-bottom: var(--spacing-xl);">
        <h1 style="margin-bottom: var(--spacing-sm);">{p.data.title}</h1>
        {p.data.role && (
          <p style="font-size: 1.125rem; color: var(--color-primary); font-weight: 600; margin-bottom: var(--spacing-md);">
            {p.data.role}
          </p>
        )}
        {p.data.pitch && (
          <p style="font-size: 1.125rem; line-height: 1.8; color: var(--color-text-muted);">
            {p.data.pitch}
          </p>
        )}
      </header>

      <!-- Highlights -->
      {p.data.highlights && p.data.highlights.length > 0 && (
        <section class="reveal" style="margin-bottom: var(--spacing-xl);">
          <h2>Highlights</h2>
          <ul style="list-style: none; padding: 0;">
            {p.data.highlights.map((h: string) => (
              <li style="padding: var(--spacing-md); border-bottom: 1px solid var(--color-border); display: flex; align-items: start; gap: var(--spacing-sm);">
                <span style="color: var(--color-primary); font-size: 1.25rem;">‚ú®</span>
                <span>{h}</span>
              </li>
            ))}
          </ul>
        </section>
      )}

      <!-- Gallery with Placeholder Support -->
      {(p.data.gallery && p.data.gallery.length > 0) || p.data.hasGalleryPlaceholder ? (
        <section class="reveal" style="margin-bottom: var(--spacing-xl);">
          <h2>Media</h2>
          <div style="display: grid; gap: var(--spacing-md); grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
            {p.data.gallery && p.data.gallery.length > 0 ? (
              p.data.gallery.map((item) => {
                if (typeof item === 'string') {
                  return (
                    <img 
                      src={item} 
                      alt="" 
                      style="width: 100%; border-radius: 8px; border: 1px solid var(--color-border);" 
                    />
                  );
                }
                
                const { src, type, alt, caption, poster } = item;
                
                return (
                  <figure style="margin: 0;">
                    {type === 'video' ? (
                      <video 
                        src={src} 
                        poster={poster}
                        controls 
                        style="width: 100%; border-radius: 8px; border: 1px solid var(--color-border);"
                      >
                        Your browser doesn't support video.
                      </video>
                    ) : (
                      <img 
                        src={src} 
                        alt={alt || ''} 
                        style="width: 100%; border-radius: 8px; border: 1px solid var(--color-border);" 
                      />
                    )}
                    {caption && (
                      <figcaption style="font-size: 0.875rem; margin-top: var(--spacing-xs); text-align: center; color: var(--color-text-muted);">
                        {caption}
                      </figcaption>
                    )}
                  </figure>
                );
              })
            ) : (
              <div style="grid-column: 1 / -1; display: grid; gap: var(--spacing-md); grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                <div style="aspect-ratio: 16/9; background: var(--color-bg-secondary); border: 2px dashed var(--color-border); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: var(--spacing-sm); color: var(--color-text-muted); padding: var(--spacing-lg);">
                  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5;">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                  </svg>
                  <p style="text-align: center; margin: 0;">Screenshots coming soon</p>
                </div>
                <div style="aspect-ratio: 16/9; background: var(--color-bg-secondary); border: 2px dashed var(--color-border); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: var(--spacing-sm); color: var(--color-text-muted); padding: var(--spacing-lg);">
                  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5;">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                  </svg>
                  <p style="text-align: center; margin: 0;">Gameplay videos coming soon</p>
                </div>
              </div>
            )}
          </div>
        </section>
      ) : null}

      <!-- External Media Links -->
      {p.data.media && p.data.media.length > 0 && (
        <section class="reveal" style="margin-bottom: var(--spacing-xl);">
          <h2>Media & Demos</h2>
          <div class="grid">
            {p.data.media.map((m: { label: string; href: string }) => (
              <a class="card" href={m.href} target="_blank" rel="noopener" style="padding: var(--spacing-md);">
                <h3 style="font-size: 1.125rem; margin-bottom: var(--spacing-xs);">{m.label}</h3>
                <p style="color: var(--color-text-muted); font-size: 0.875rem; margin: 0;">View external link ‚Üí</p>
              </a>
            ))}
          </div>
        </section>
      )}

      <!-- Code & Links -->
      {p.data.links && p.data.links.length > 0 && (
        <section class="reveal" style="margin-bottom: var(--spacing-xl);">
          <h2>Code & Links</h2>
          <div class="grid">
            {p.data.links.map((l: { label: string; href: string }) => (
              <a class="card" href={l.href} target="_blank" rel="noopener" style="padding: var(--spacing-md);">
                <h3 style="font-size: 1.125rem; margin-bottom: var(--spacing-xs);">{l.label}</h3>
                <p style="color: var(--color-text-muted); font-size: 0.875rem; margin: 0;">Open ‚Üí</p>
              </a>
            ))}
          </div>
        </section>
      )}

      <!-- Lessons Learned -->
      {p.data.lessons && p.data.lessons.length > 0 && (
        <section class="reveal" style="margin-bottom: var(--spacing-xl);">
          <h2>Lessons Learned</h2>
          <ul style="list-style: none; padding: 0;">
            {p.data.lessons.map((l: string) => (
              <li style="padding: var(--spacing-md); border-bottom: 1px solid var(--color-border); display: flex; align-items: start; gap: var(--spacing-sm);">
                <span style="color: var(--color-primary); font-size: 1.25rem;">üí°</span>
                <span>{l}</span>
              </li>
            ))}
          </ul>
        </section>
      )}

      <!-- About Section with Markdown Content -->
      <section class="reveal prose" style="margin-bottom: var(--spacing-xl);">
        <h2>About This Project</h2>
        <Content />
      </section>

      <!-- Previous/Next Navigation -->
      <nav class="reveal" style="display: flex; justify-content: space-between; gap: var(--spacing-md); padding-top: var(--spacing-xl); border-top: 1px solid var(--color-border); flex-wrap: wrap;">
        {prevProject ? (
          <a href={`/projects/${prevProject.slug}/`} style="text-decoration: none; color: var(--color-text); flex: 1; min-width: 200px;">
            <div style="font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: var(--spacing-xs);">‚Üê Previous</div>
            <div style="font-weight: 600;">{prevProject.data.title}</div>
          </a>
        ) : (
          <div style="flex: 1; min-width: 200px;"></div>
        )}
        
        <a href="/projects" style="text-align: center; padding: var(--spacing-sm) var(--spacing-md); background: var(--color-bg-secondary); border-radius: 6px; text-decoration: none; color: var(--color-text); font-weight: 500;">
          All Projects
        </a>
        
        {nextProject ? (
          <a href={`/projects/${nextProject.slug}/`} style="text-decoration: none; color: var(--color-text); text-align: right; flex: 1; min-width: 200px;">
            <div style="font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: var(--spacing-xs);">Next ‚Üí</div>
            <div style="font-weight: 600;">{nextProject.data.title}</div>
          </a>
        ) : (
          <div style="flex: 1; min-width: 200px;"></div>
        )}
      </nav>
    </div>
  </article>
</Layout>

<style>
  .prose {
    line-height: 1.8;
  }
  
  .prose :global(p) {
    margin-bottom: var(--spacing-md);
    color: var(--color-text-muted);
  }
  
  .prose :global(h2),
  .prose :global(h3) {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-md);
    color: var(--color-text);
  }
  
  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-lg);
  }
  
  .prose :global(li) {
    margin-bottom: var(--spacing-sm);
  }
  
  .prose :global(code) {
    background: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.875em;
    border: 1px solid var(--color-border);
  }
</style>
