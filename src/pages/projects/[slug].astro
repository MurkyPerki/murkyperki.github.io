---
import Layout from "../../layouts/Layout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((p) => ({ params: { slug: p.slug }, props: { p } }));
}

const { p } = Astro.props as { p: CollectionEntry<"projects"> };
const { Content } = await p.render();
---
<Layout title={`${p.data.title} — Max Burkhardt`}>
  <article style="max-width: 800px; margin: 0 auto;">
    <header style="margin-bottom: 3rem;">
      <h1>{p.data.title}</h1>
      {p.data.role && <p class="muted" style="font-size: 1.125rem; margin-top: 0.5rem;">{p.data.role}</p>}
      {p.data.pitch && <p style="font-size: 1.125rem; margin-top: 1rem; line-height: 1.7;">{p.data.pitch}</p>}
    </header>

    {p.data.highlights && p.data.highlights.length > 0 && (
      <section style="margin-bottom: 3rem;">
        <h2>Highlights</h2>
        <ul style="list-style: none; padding: 0;">
          {p.data.highlights.map((h: string) => (
            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);"> {h}</li>
          ))}
        </ul>
      </section>
    )}

    {/* Gallery Section with Placeholder Support */}
    {(p.data.gallery && p.data.gallery.length > 0) || p.data.hasGalleryPlaceholder ? (
      <section style="margin-bottom: 3rem;">
        <h2>Gallery</h2>
        <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
          {p.data.gallery && p.data.gallery.length > 0 ? (
            p.data.gallery.map((item) => {
              if (typeof item === 'string') {
                return (
                  <img 
                    src={item} 
                    alt="" 
                    style="width: 100%; border-radius: 8px; border: 1px solid var(--border);" 
                  />
                );
              }
              
              const { src, type, alt, caption, poster } = item;
              
              return (
                <figure style="margin: 0;">
                  {type === 'video' ? (
                    <video 
                      src={src} 
                      poster={poster}
                      autoplay
                      muted
                      loop
                      style="width: 100%; border-radius: 8px; border: 1px solid var(--border);"
                    >
                      Your browser doesn't support video.
                    </video>
                  ) : (
                    <img 
                      src={src} 
                      alt={alt || ''} 
                      style="width: 100%; border-radius: 8px; border: 1px solid var(--border);" 
                    />
                  )}
                  {caption && (
                    <figcaption class="muted" style="font-size: 0.875rem; margin-top: 0.5rem; text-align: center;">
                      {caption}
                    </figcaption>
                  )}
                </figure>
              );
            })
          ) : (
            <div class="placeholder-gallery">
              <div class="placeholder-item">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                <p>Screenshots coming soon</p>
              </div>
              <div class="placeholder-item">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                <p>Gameplay videos coming soon</p>
              </div>
            </div>
          )}
        </div>
      </section>
    ) : null}

    {p.data.media && p.data.media.length > 0 && (
      <section style="margin-bottom: 3rem;">
        <h2>Media & Demos</h2>
        <div class="grid">
          {p.data.media.map((m: { label: string; href: string }) => (
            <a class="card" href={m.href} target="_blank" rel="noreferrer">
              <h3>{m.label}</h3>
              <p class="muted" style="font-size: 0.875rem; margin-top: 0.25rem;">View →</p>
            </a>
          ))}
        </div>
      </section>
    )}

    {p.data.links && p.data.links.length > 0 && (
      <section style="margin-bottom: 3rem;">
        <h2>Links</h2>
        <div class="grid">
          {p.data.links.map((l: { label: string; href: string }) => (
            <a class="card" href={l.href} target="_blank" rel="noreferrer">
              <h3>{l.label}</h3>
              <p class="muted" style="font-size: 0.875rem; margin-top: 0.25rem;">Open →</p>
            </a>
          ))}
        </div>
      </section>
    )}

    {p.data.lessons && p.data.lessons.length > 0 && (
      <section style="margin-bottom: 3rem;">
        <h2>Lessons Learned</h2>
        <ul style="list-style: none; padding: 0;">
          {p.data.lessons.map((l: string) => (
            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);"> {l}</li>
          ))}
        </ul>
      </section>
    )}

    <section style="margin-bottom: 3rem;">
      <h2>About</h2>
      <div class="prose">
        <Content />
      </div>
    </section>

    <a href="/" style="display: inline-block; color: var(--link); text-decoration: none; font-weight: 500;">
      ← Back to projects
    </a>
  </article>

  <style>
    .placeholder-gallery {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(2, minmax(500px, 1fr));
      width: 100%;
    }
    
    .placeholder-item {
      aspect-ratio: 16/9;
      background: var(--card);
      border: 2px dashed var(--border);
      border-radius: 1px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      color: var(--muted);
      padding: 2rem;
    }

    .placeholder-item svg {
      opacity: 0.5;
    }

    .placeholder-item p {
      font-size: 0.9375rem;
      text-align: center;
      margin: 0;
    }

    .prose {
      line-height: 1.7;
    }

    .prose p {
      margin-bottom: 1rem;
    }

    .prose ul, .prose ol {
      margin-bottom: 1rem;
      padding-left: 1.5rem;
    }

    .prose li {
      margin-bottom: 0.5rem;
    }

    .prose h2, .prose h3 {
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    .prose code {
      background: var(--card);
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-size: 0.875em;
    }
  </style>
</Layout>